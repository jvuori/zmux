# ============================================================================
# Session Management Configuration
# ============================================================================

# Session naming
set -g default-command "${SHELL}"

# Fixed window names (tabs) - disable automatic renaming
# Windows will keep their names unless manually renamed
# New windows will start with blank names (only index is shown in status bar)
# Users can rename windows manually with Ctrl+t r
setw -g automatic-rename off
set -g renumber-windows on

# Prevent tmux from changing the terminal window title
# This allows WezTerm to keep its custom window title
set-option -g set-titles off
set-option -g allow-rename off

# Hook to clear window name when new window is created
# This ensures new windows start with blank names instead of process names
set-hook -g after-new-window 'rename-window ""'

# Fix startup flicker: refresh client after attachment to ensure proper pane sizing
# This prevents panes from being displayed before terminal size is known
# The -S flag forces a synchronous refresh to ensure layout is calculated before display
set-hook -g client-attached 'refresh-client -S'
set-hook -g after-new-session 'refresh-client -S'

# Capture cursor-agent session IDs after restore
# Run in background with a delay to allow processes to start and output to appear
set-hook -g client-attached 'run-shell -b "sleep 3 && ~/.config/tmux/scripts/capture-cursor-agent-session.sh"'

# Track active session for restoration
# Update the active-session.txt file whenever a client session changes
# This ensures we always know which session was active, even if tmux is killed unexpectedly
set-hook -g client-session-changed 'run-shell -b "~/.config/tmux/scripts/track-active-session.sh #{client_session}"'

# Session persistence (works with tmux-resurrect plugin)
# Sessions are automatically saved and restored
# Note: Some interactive TUI programs (like LazyGit) may not restore perfectly
# when the server is killed, as they're terminated before proper save

# Zellij-like session behavior
# Keep sessions alive even when no clients attached
set -g detach-on-destroy off
set -g destroy-unattached off

# Default session name (used when creating new sessions)
# Note: Use tmux-start.sh script for automatic session restoration
# It will restore last active session or create "default" if none exist

# ============================================================================
# Session Creation
# ============================================================================

# Create new session with name
bind C-c new-session -d

# ============================================================================
# Session Navigation
# ============================================================================

# Switch to previous/next session
bind ( switch-client -p
bind ) switch-client -n

# List sessions (interactive)
bind C-s choose-session

# ============================================================================
# Session Attach/Detach
# ============================================================================

# Detach all other clients
bind D if-shell "$(tmux list-clients | wc -l | xargs)" \
  "detach-client -a" \
  "display-message 'Only one client attached'"

