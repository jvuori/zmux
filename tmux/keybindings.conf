# ============================================================================
# Zellij-like Keybindings
# ============================================================================
# These keybindings match Zellij's default keybindings as closely as possible
# Reference: https://github.com/zellij-org/zellij/blob/main/zellij-utils/assets/config/default.kdl

# ============================================================================
# Plugin Configuration (must be before mode definitions)
# ============================================================================
# Disable copycat's git search binding (C-g) so we can use it for lock mode
set -g @copycat_git_special ""

# For copycat_search_option, we need to set it to avoid conflicts
# Set it to something else or empty
set -g @copycat_search "C-f"

# Change prefix from Ctrl+b to Ctrl+a (quicker to type)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# ============================================================================
# Mode Activation (Zellij defaults - direct key combinations)
# ============================================================================

# Pane mode: Ctrl+p
bind -n C-p switch-client -T pane

# Resize mode: Ctrl+n (change border to red when entering)
bind -n C-n set -g pane-border-style "fg=colour1" \; set -g pane-active-border-style "fg=colour1" \; switch-client -T resize

# Move mode: Ctrl+h (change border to red when entering)
bind -n C-h set -g pane-border-style "fg=colour1" \; set -g pane-active-border-style "fg=colour1" \; switch-client -T move

# Tab mode: Ctrl+t
bind -n C-t switch-client -T tab

# Scroll mode: Ctrl+s (enters copy-mode directly)
# Scroll bindings are in copy-mode-vi below

# Session mode: Ctrl+o
bind -n C-o switch-client -T session

# ============================================================================
# Quick Tab Navigation (Root mode only)
# ============================================================================
# Switch between tabs without entering tab mode - for faster navigation

# Ctrl+Left/Right: Switch tabs
bind -n C-Left select-window -t :-
bind -n C-Right select-window -t :+

# ============================================================================
# Lock Mode (Ctrl+l) - Zellij-like lock mode
# ============================================================================
# In lock mode, all keyboard input goes directly to the application without
# being intercepted by tmux. Only Ctrl+l toggles lock mode.
# Visual indicator "LOCK" shows in status bar when active.

# Bind Ctrl+l in root table to enter lock mode
bind -T root C-l \
  set-option @lock_mode 1 \; \
  switch-client -T locked \; \
  refresh-client

# In locked mode, Ctrl+l exits lock mode
bind -T locked C-l \
  set-option @lock_mode 0 \; \
  switch-client -T root \; \
  refresh-client

# Note: Unbound keys will automatically exit locked mode (tmux default behavior)
# The lock-mode-indicator.sh script handles showing/hiding the ðŸ”’ LOCK icon

# Source comprehensive lock mode key bindings (253 keys)
# This covers all common keys: Ctrl+*, Alt+*, arrows, Fn keys, special keys, etc.
# Generated by scripts/generate-lock-mode-bindings.sh
source-file ~/.config/tmux/lock-mode-bindings.conf

# Override: Bind Ctrl+l to exit lock mode (takes precedence over the generated bindings)
bind -T locked C-l \
  set-option @lock_mode 0 \; \
  switch-client -T root \; \
  refresh-client

# ============================================================================
# Pane Mode Keybindings (Ctrl+p)
# ============================================================================
# Based on Zellij's pane mode

# Exit pane mode
bind -T pane C-p switch-client -T root

# Navigation (move focus)
bind -T pane h select-pane -L
bind -T pane Left select-pane -L
bind -T pane l select-pane -R
bind -T pane Right select-pane -R
bind -T pane j select-pane -D
bind -T pane Down select-pane -D
bind -T pane k select-pane -U
bind -T pane Up select-pane -U

# Switch focus (toggle between panes)
bind -T pane p switch-client -T root \; select-pane -t :.+

# Create new panes (Zellij: n=NewPane, d=NewPane Down, r=NewPane Right, s=NewPane stacked)
# Smart pane creation: if pane is wider than tall, split horizontally; otherwise vertically
bind -T pane n if-shell 'test "#{pane_width}" -gt "#{pane_height}"' \
  'split-window -h -c "#{pane_current_path}"' \
  'split-window -v -c "#{pane_current_path}"' \; \
  switch-client -T root
bind -T pane d split-window -v -c "#{pane_current_path}" \; switch-client -T root
bind -T pane r split-window -h -c "#{pane_current_path}" \; switch-client -T root
bind -T pane s split-window -v -c "#{pane_current_path}" \; switch-client -T root

# Close pane
bind -T pane x kill-pane \; switch-client -T root

# Toggle fullscreen
bind -T pane f resize-pane -Z \; switch-client -T root

# Toggle pane frames (zoom)
bind -T pane z run-shell "tmux setw pane-border-status" \; switch-client -T root

# ============================================================================
# Resize Mode Keybindings (Ctrl+n)
# ============================================================================
# Based on Zellij's resize mode - arrow keys resize the active pane
# Press Ctrl+n to enter, use arrow keys to resize continuously, press Enter to exit
# The key table stays active until you explicitly exit with Enter or Ctrl+n

# Exit resize mode (Ctrl+n or Enter, like Zellij) - restore green border
bind -T resize C-n set -g pane-border-style "fg=colour46" \; set -g pane-active-border-style "fg=colour46" \; switch-client -T root
bind -T resize Enter set -g pane-border-style "fg=colour46" \; set -g pane-active-border-style "fg=colour46" \; switch-client -T root
bind -T resize Escape set -g pane-border-style "fg=colour46" \; set -g pane-active-border-style "fg=colour46" \; switch-client -T root

# Resize with arrow keys (increase size) - stay in resize mode
bind -T resize Left resize-pane -L 5 \; switch-client -T resize
bind -T resize Right resize-pane -R 5 \; switch-client -T resize
bind -T resize Up resize-pane -U 5 \; switch-client -T resize
bind -T resize Down resize-pane -D 5 \; switch-client -T resize

# Resize with hjkl (increase size) - stay in resize mode
bind -T resize h resize-pane -L 5 \; switch-client -T resize
bind -T resize l resize-pane -R 5 \; switch-client -T resize
bind -T resize k resize-pane -U 5 \; switch-client -T resize
bind -T resize j resize-pane -D 5 \; switch-client -T resize

# Resize with capital letters (decrease size) - stay in resize mode
bind -T resize H resize-pane -R 5 \; switch-client -T resize
bind -T resize L resize-pane -L 5 \; switch-client -T resize
bind -T resize K resize-pane -D 5 \; switch-client -T resize
bind -T resize J resize-pane -U 5 \; switch-client -T resize

# Increase/decrease all - stay in resize mode
bind -T resize = resize-pane -y 5 \; resize-pane -x 5 \; switch-client -T resize
bind -T resize + resize-pane -y 5 \; resize-pane -x 5 \; switch-client -T resize
bind -T resize - resize-pane -y -5 \; resize-pane -x -5 \; switch-client -T resize

# ============================================================================
# Move Mode Keybindings (Ctrl+h)
# ============================================================================
# Based on Zellij's move mode - arrow keys move panes
# Press Ctrl+h to enter, use arrow keys to move continuously, press Enter to exit

# Exit move mode (Ctrl+h, Enter, or Escape) - restore green border
bind -T move C-h set -g pane-border-style "fg=colour46" \; set -g pane-active-border-style "fg=colour46" \; switch-client -T root
bind -T move Enter set -g pane-border-style "fg=colour46" \; set -g pane-active-border-style "fg=colour46" \; switch-client -T root
bind -T move Escape set -g pane-border-style "fg=colour46" \; set -g pane-active-border-style "fg=colour46" \; switch-client -T root

# Move pane with arrow keys - stay in move mode
# Swap with adjacent pane in the direction of the arrow
# Note: -L and -R are not valid in tmux 3.4, so we use helper scripts for left/right
# For up/down, -U and -D work correctly
bind -T move Left run-shell '/home/jaakko/.config/tmux/scripts/swap-pane-left.sh' \; switch-client -T move
bind -T move Right run-shell '/home/jaakko/.config/tmux/scripts/swap-pane-right.sh' \; switch-client -T move
bind -T move Up swap-pane -U \; switch-client -T move
bind -T move Down swap-pane -D \; switch-client -T move

# Move pane with hjkl - stay in move mode
# h=left, l=right, k=up, j=down
bind -T move h run-shell '/home/jaakko/.config/tmux/scripts/swap-pane-left.sh' \; switch-client -T move
bind -T move l run-shell '/home/jaakko/.config/tmux/scripts/swap-pane-right.sh' \; switch-client -T move
bind -T move k swap-pane -U \; switch-client -T move
bind -T move j swap-pane -D \; switch-client -T move

# Move pane to next/previous position - stay in move mode
bind -T move n swap-pane -t :.+ \; switch-client -T move
bind -T move Tab swap-pane -t :.+ \; switch-client -T move
bind -T move p swap-pane -t :.- \; switch-client -T move

# ============================================================================
# Tab Mode Keybindings (Ctrl+t)
# ============================================================================
# Based on Zellij's tab mode

# Exit tab mode
bind -T tab C-t switch-client -T root

# Navigation
bind -T tab h previous-window
bind -T tab Left previous-window
bind -T tab l next-window
bind -T tab Right next-window
bind -T tab j next-window
bind -T tab Down next-window
bind -T tab k previous-window
bind -T tab Up previous-window

# Create new tab
bind -T tab n new-window -c "#{pane_current_path}" \; switch-client -T root

# Close tab
bind -T tab x kill-window \; switch-client -T root

# Rename tab
bind -T tab r command-prompt -I "#W" "rename-window '%%'" \; switch-client -T root

# Switch to tab by number
bind -T tab 1 select-window -t 1 \; switch-client -T root
bind -T tab 2 select-window -t 2 \; switch-client -T root
bind -T tab 3 select-window -t 3 \; switch-client -T root
bind -T tab 4 select-window -t 4 \; switch-client -T root
bind -T tab 5 select-window -t 5 \; switch-client -T root
bind -T tab 6 select-window -t 6 \; switch-client -T root
bind -T tab 7 select-window -t 7 \; switch-client -T root
bind -T tab 8 select-window -t 8 \; switch-client -T root
bind -T tab 9 select-window -t 9 \; switch-client -T root

# Toggle tab (go to last active)
bind -T tab Tab last-window

# ============================================================================
# Scroll Mode Keybindings (Ctrl+s)
# ============================================================================
# Based on Zellij's scroll mode
# Note: Scroll mode enters copy-mode, so we bind to copy-mode-vi

# Enter scroll mode (copy-mode)
bind -n C-s copy-mode

# Exit scroll mode (from copy-mode)
bind -T copy-mode-vi C-s send-keys -X cancel

# Enter search mode
bind -T copy-mode-vi s send-keys /

# Scroll (in copy-mode)
bind -T copy-mode-vi j send-keys -X cursor-down
bind -T copy-mode-vi Down send-keys -X cursor-down
bind -T copy-mode-vi k send-keys -X cursor-up
bind -T copy-mode-vi Up send-keys -X cursor-up

# Page scroll
bind -T copy-mode-vi C-f send-keys -X page-down
bind -T copy-mode-vi PageDown send-keys -X page-down
bind -T copy-mode-vi l send-keys -X page-down
bind -T copy-mode-vi Right send-keys -X page-down
bind -T copy-mode-vi C-b send-keys -X page-up
bind -T copy-mode-vi PageUp send-keys -X page-up
bind -T copy-mode-vi h send-keys -X page-up
bind -T copy-mode-vi Left send-keys -X page-up

# Half page scroll
bind -T copy-mode-vi d send-keys -X halfpage-down
bind -T copy-mode-vi u send-keys -X halfpage-up

# Scroll to bottom and exit
bind -T copy-mode-vi C-c send-keys -X history-bottom \; send-keys -X clear-selection \; send-keys -X cancel

# ============================================================================
# Session Mode Keybindings (Ctrl+o)
# ============================================================================
# Based on Zellij's session mode

# Exit session mode
bind -T session C-o switch-client -T root

# Detach
bind -T session d detach-client

# Enter scroll mode from session mode (copy-mode)
bind -T session C-s copy-mode

# Create new session (Zellij-like: n for new)
bind -T session n command-prompt -p "Session name:" "new-session -s '%%'" \; switch-client -T root

# Rename current session (Zellij-like: r for rename)
bind -T session r command-prompt -I "#S" -p "Rename session to:" "rename-session '%%'" \; switch-client -T root

# Session manager (Zellij: w launches session-manager plugin)
# Uses tmux-fzf plugin (required) - opens in fullscreen
# Use -b flag to run in background (required for interactive fzf)
# Pass current session name as first argument to ensure correct context
bind -T session w run-shell -b "~/.config/tmux/scripts/session-switcher.sh '#{session_name}'"

# Session killer (delete sessions)
# Uses tmux-fzf plugin to delete one or more sessions
bind -T session x run-shell -b "~/.config/tmux/scripts/session-killer.sh"

# Configuration (Zellij: c launches configuration plugin)
# In tmux, we show config info
bind -T session c display-message "zmux config: ~/.config/tmux/" \; switch-client -T root

# Plugin manager (Zellij: p launches plugin-manager)
# In tmux, we show plugin info
bind -T session p display-message "Plugins: Use Ctrl+a i to install, Ctrl+a u to update" \; switch-client -T root

# About (Zellij: a launches about plugin)
bind -T session a display-message "zmux - Zellij-like tmux configuration" \; switch-client -T root

# Share (Zellij: s launches share plugin)
# Not available in tmux, show message
bind -T session s display-message "Session sharing not available in tmux" \; switch-client -T root

# Sequence (Zellij: q launches sequence plugin)
# Not available in tmux, show message
bind -T session q display-message "Sequence plugin not available in tmux" \; switch-client -T root

# ============================================================================
# Shared Keybindings (available in all modes except locked)
# ============================================================================

# Lock session (Ctrl+a) - works from root key table
bind C-a switch-client -T locked \; display-message "Locked (press Ctrl+a to unlock)"

# Quit (Ctrl+q) - Save sessions before killing server
# Note: Some TUI programs (like LazyGit) may not restore perfectly
# because they're terminated when the server is killed
bind -n C-q confirm-before -p "kill all sessions? (y/n)" \
  "run-shell '~/.tmux/plugins/tmux-resurrect/scripts/save.sh' \; run-shell 'sleep 0.5' \; kill-server"

# Alt keybindings (like Zellij - shared_except "locked")
# Note: Some Zellij features are not available in tmux, so we provide reasonable alternatives

# Alt+f: Toggle floating panes (Zellij) - in tmux we toggle pane border status
bind -n M-f run-shell "tmux setw -g pane-border-status" \; display-message "Toggle pane frames"

# Alt+n: New pane (Zellij)
bind -n M-n split-window -v -c "#{pane_current_path}"

# Alt+i: Move tab left (Zellij)
bind -n M-i swap-window -t -1

# Alt+o: Move tab right (Zellij)
bind -n M-o swap-window -t +1

# Alt+h/Alt+Left: Move focus/tab left (Zellij: MoveFocusOrTab "Left")
bind -n M-h select-pane -L
bind -n M-Left select-pane -L

# Alt+l/Alt+Right: Move focus/tab right (Zellij: MoveFocusOrTab "Right")
bind -n M-l select-pane -R
bind -n M-Right select-pane -R

# Alt+j/Alt+Down: Move focus down (Zellij)
bind -n M-j select-pane -D
bind -n M-Down select-pane -D

# Alt+k/Alt+Up: Move focus up (Zellij)
bind -n M-k select-pane -U
bind -n M-Up select-pane -U

# Alt+=/Alt++: Resize increase (Zellij)
bind -n M-= resize-pane -y 5 \; resize-pane -x 5
bind -n M-+ resize-pane -y 5 \; resize-pane -x 5

# Alt+-: Resize decrease (Zellij)
bind -n M-- resize-pane -y -5 \; resize-pane -x -5

# Alt+[: Previous swap layout (Zellij) - in tmux we cycle through layouts
bind -n M-[ select-layout -o

# Alt+]: Next swap layout (Zellij) - in tmux we cycle through layouts
bind -n M-] select-layout -o

# Alt+p: Toggle pane in group (Zellij) - in tmux we toggle pane synchronization
bind -n M-p setw synchronize-panes \; display-message "Pane sync toggled"

# Alt+Shift+p: Toggle group marking (Zellij) - not available in tmux
bind -n M-P display-message "Group marking not available in tmux"

# ============================================================================
# Copy Mode (vi-like, similar to Zellij)
# ============================================================================

# Enter copy mode with v (vi-like)
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi r send-keys -X rectangle-toggle

# Improved mouse wheel scrolling in copy mode
# Note: Edge scrolling during drag selection works but is slower than Zellij.
# The automatic edge scrolling speed is hardcoded in tmux and cannot be changed
# through configuration. This is a known limitation compared to Zellij.
# Workarounds for faster scrolling while selecting:
# - Use mouse wheel to scroll faster while keeping button pressed (recommended)
# - Or use keyboard navigation: j/k (line), d/u (half page), l/h (full page)
# The default behavior scrolls 5 lines per wheel tick for faster navigation
bind -T copy-mode-vi WheelUpPane select-pane \; send-keys -X -N 5 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 5 scroll-down
# Also bind in regular copy-mode (non-vi) for compatibility
bind -T copy-mode WheelUpPane select-pane \; send-keys -X -N 5 scroll-up
bind -T copy-mode WheelDownPane select-pane \; send-keys -X -N 5 scroll-down

# ============================================================================
# Utility Keybindings
# ============================================================================

# Reload config (custom, not in Zellij)
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"

# Show help
bind ? display-popup -w 120 -h 40 "bash ~/.config/tmux/scripts/show-help.sh | less -R"

# TPM plugin management (lowercase for faster typing)
# Ctrl+a -> i: Install plugins
bind i run-shell '~/.tmux/plugins/tpm/bin/install_plugins' \; display-message "Installing plugins..."
# Ctrl+a -> u: Update plugins
bind u run-shell '~/.tmux/plugins/tpm/bin/update_plugins all' \; display-message "Updating plugins..."

# tmux-resurrect keybindings (save/restore sessions)
# These use Ctrl+s and Ctrl+r which conflict with our scroll mode
# So we'll use them with prefix (Ctrl+a)
bind C-s run-shell '~/.tmux/plugins/tmux-resurrect/scripts/save.sh' \; display-message "Session saved"
bind C-r run-shell '~/.tmux/plugins/tmux-resurrect/scripts/restore.sh' \; display-message "Session restored" \; run-shell -b "sleep 3 && ~/.config/tmux/scripts/capture-cursor-agent-session.sh"

# tmux-fzf bindings (if installed)
# These work alongside our Zellij keybindings
# prefix + s â†’ sessions (via tmux-fzf)
# prefix + w â†’ windows (via tmux-fzf)  
# prefix + p â†’ panes (via tmux-fzf)
# Note: We use Ctrl+t for tab mode, so these don't conflict
